\subsection{Security}

We will call a query to the random oracle $\mu$-\textit{successful} if the
random oracle returns a value $h$ such that $h \leq 2^{-\mu}T$.

In order to prove our construction secure, we first define the boolean random
variables $X_r^\mu$, $Y_r^\mu$ and $Z_r^\mu$, akin to the random variables
$X_r$, $Y_r$ and $Z_r$ of the backbone setting\cite{backbone}. For each round
$r$ and for each query index $j$ and for each $k$ adversarial party index (out
of $t$), define these random variables as follows.  If at round $i$ an honest
party obtains a PoW with $id < 2^{-\mu}T$, then $X_r^\mu = 1$, otherwise
$X_r^\mu = 0$. If at round $r$ exactly one honest party obtains a PoW with $id <
2^{-\mu}T$, then $Y_r^\mu = 1$, otherwise $Y_r^\mu = 0$. Regarding the
adversary, if at round $r$ the $j$-th query of the $k$-th corrupted party is
$\mu$-successful, then $Z^\mu_{ijk} = 1$, otherwise $Z^\mu_{ijk} = 0$. Further
define $Z^\mu_r = \sum_{k=1}^t \sum_{j=1}^q Z^\mu_{ijk}$, where $q$ denotes the
total number of queries. For a set of rounds $S$, let $X^\mu(S) = \sum_{r \in S}
X_r$ and similarly define $Y^\mu(S)$ and $Z^\mu(S)$.

We now extend the definition of a \textit{typical execution} from the backbone
setting\cite{backbone}.

\begin{definition}{(Typical execution)}
    An execution of the protocol is $(\epsilon, \eta)$-\textit{typical} if, for
    all $\mu$ it holds that for any set $S$ of consecutive rounds with $|S| \geq
    2^\mu \eta\kappa$, the following hold:

    \begin{itemize}
        \item $(1 - \epsilon)E[X^\mu(S)] < X^\mu(S) < (1 + \epsilon)E[X^\mu(S)]$ and $(1 - \epsilon)E[Y^\mu(S)] < Y^\mu(s)$.
        \item $Z^\mu(S) < (1 + \epsilon)E[Z^\mu(S)]$.
    \end{itemize}

    Furthermore, we require that the execution is typical according to the
    backbone definition.
\end{definition}

Executions are typical with overwhelming probability.
\aknote{at least sketch the proof of this}

\begin{lemma}\label{lem:negbin}
    Let $S$ be a set of consecutive rounds such that $Z_S \geq k$ for some
    security parameter $k$. Then we have that $|S| \geq (1 -
    \epsilon)2^\mu\frac{k}{pqt}$ with overwhelming probability in $k$.
\end{lemma}
\begin{proof}
    First, observe that $Z_{ijk}^\mu \sim \textsf{Bern}(2^{-\mu}p)$ and these are
    jointly independent. Therefore $Z_S^\mu \sim \textsf{Bin}(tq|S|, 2^{-\mu}p)$ and
    $|S| \sim \textsf{NB}(Z_S, 2^{-\mu}p)$. So $\mathbb{E}(|S|) =
    2^\mu\frac{Z_S}{pqt}$. Applying a tail bound to the negative binomial
    distribution, we obtain that $\Pr[|S| < (1 - \epsilon)\mathbb{E}(|S|)] \in
    \Omega(\epsilon^2 m)$.
    \qed
\end{proof}

The following lemma is at the heart of the security proof that will follow.

\aknote{
XXX mention below that you are a in typical execution XXX}

\begin{lemma}\label{lem:level-comparison}
    Suppose $S$ is a set of consecutive rounds $r_1 \ldots r_2$  
    and $\chain_B$ is
    a chain adopted by an honest party at round $r_2$. Let $\chain_B^S = \{b \in
    \chain_B: b \textnormal{ was generated during } S\}$. Let $\mu_\mathcal{A},
    \mu_B \in \mathbb{N}$. Suppose $\chain_B^S\upchain^{\mu_B}$ is good.
    Suppose $\chain'_\mathcal{A}$ is a $\mu_\mathcal{A}$-superchain containing
    only adversarially generated blocks generated during $S$ and suppose that
    $|\chain'_\mathcal{A}| \geq k$.
    Then:

    \begin{equation*}
    2^{\mu_\mathcal{A}}|\chain'_\mathcal{A}| < \frac{1}{3}2^{\mu_B}|\chain_B^S\upchain^{\mu_B}|
    \end{equation*}
\end{lemma}
\begin{proof}
    From $|\chain'_\mathcal{A}| \geq k$ we know that $Z_S \geq k$. Applying
    Lemma~\ref{lem:negbin}, we conclude that $|S| \geq (1 -
    \epsilon')2^{\mu_A}\frac{1}{pqt}|\chain'_\mathcal{A}|$.

    Applying the chain growth theorem \cite{backbone} we obtain that $|\chain_B^S|
    \geq (1 - \epsilon)f|S|$. But from the goodness of $\chain_B^S\upchain^{\mu_B}$, we
    know that $|\chain_B^S\upchain^{\mu_B}| \geq (1 -
    \delta)2^{-\mu_B}|\chain_B^S|$. Therefore $|\chain_B^S\upchain^{\mu_B}| \geq
    2^{-\mu_B}(1 - \delta)(1 - \epsilon)f(1 -
    \epsilon')2^{\mu_\mathcal{A}}\frac{1}{pqt}|\chain'_\mathcal{A}|$ and so:

    \begin{equation*}
    2^{\mu_\mathcal{A}}|\chain'_\mathcal{A}|
    <
    \frac{pqt}{(1 - \delta)(1 -
    \epsilon')(1 - \epsilon)f}2^{\mu_B}|\chain_B^S\upchain^{\mu_B}|
    \end{equation*}
    \qed
\end{proof}

% \begin{lemma}
%     If the maximum level superchain belonging to the honest parties of at least
%     $m$ blocks is of level $\mu$, then the adversary cannot produce a
%     superchain of level better than $\mu + 1$ with at least $m$ blocks except
%     with negligible probability.
% \end{lemma}
% \begin{proof}
%     ???
% \end{proof}
%
% Based on the above, observe that the adversarial proof cannot exceed the
% superblock level of the honest proof by more than one, except with negligible
% probability. Therefore, proofs that are of much inferior superblock level can
% be rejected immediately. This allows us to assume that for two competing proofs
% $\overline{\Pi}_\alpha$ and $\overline{\Pi}_\beta$ it holds that
% $||\overline{\Pi}_A| - |\overline{\Pi}_B|| \leq 1$.
%

\begin{definition}{(Full level of honest proof)}
Let $\tilde\pi$ be an honestly generated proof parsed as $\overline\pi$ and constructed upon some adopted chain $\chain$ and let $b$ be any block in
$\tilde\pi$. Then $\mu'$ is defined as follows:

\begin{equation*}
\mu' = \max\{\mu: |\overline\pi[\mu]\{b:\}[1:]| \geq \max(m, (1 - \delta)2^{-\mu}|\overline\pi[\mu]\{b:\}[1:]\downchain|)\}
\end{equation*}

We call $\mu'$ the \textit{full} level of proof $\tilde\pi$ with respect to
block $b$ with security parameters $\delta$ and $m$.
\end{definition}

\begin{lemma}\label{lem:allblocks}
Let $\overline\pi = \textsf{parse}(\tilde\pi)$ be the parsed proof of some
honest proof $\tilde\pi$ generated with security parameters $\delta, m$. Let
$\chain$ be the underlying chain, $b \in \chain$ be any block and $\mu'$ be the
full level of the proof with respect to $b$ and the same security parameters.
Then
\begin{equation*}
\chain\{b:\}\upchain^{\mu'} = \overline\pi[\mu']\{b:\}
\end{equation*}
\end{lemma}
\begin{proof}
    $\overline\pi[\mu']\{b:\} \subseteq \chain\{b:\}\upchain^{\mu'}$ is trivial.

    For the converse, we will show that for all $\mu^* > \mu'$, we have that in
    the iteration of the Prove \texttt{for} loop with $\mu = \mu^*$, the block stored
    in variable $B$ preceeds block $b$ in $\chain$.

    Suppose $\mu = \mu^*$ is the first \texttt{for} loop iteration during which the
    property is violated. Clearly this cannot be the first iteration, as there
    $B = \chain[0]$ and Genesis preceeds all blocks, including itself. By the
    induction hypothesis we see that during the iteration $\mu = \mu^* + 1$,
    block $B$ preceeded block $b$. But from the definition of $\mu'$ we know
    that $\mu'$ is the highest level for which
    $|\overline\pi[\mu']\{b:\}[1:]|
    \geq \max(m, (1 -
    \delta)2^{-\mu'}|\overline\pi[\mu']\{b:\}[1:]\downchain|)$.

    Hence, this
    property cannot hold for $\mu^* > \mu'$ and therefore
    $|\overline\pi_B[\mu_B^*]\{b:\}[1:]| < m$ or
    $\lnot \textsf{local-good}_\delta(\overline\pi[\mu^*]\{b:\}[1:], \chain, \mu^*)$.

    In case \textsf{local-good} is violated, variable $B$ remains unmodified and
    the induction step holds. If \textsf{local-good} is not violated, then
    $|\overline\pi[\mu^*]\{b:\}[1:]| < m$ and so $\overline\pi[\mu^*][-m]$
    preceeds $b$, and so we are done.
    \qed
\end{proof}

\begin{lemma}
Suppose the verifier evaluates $\tilde\pi_\mathcal{A} \geq \tilde\pi_B$ in a protocol interaction where $B$ is honest and assume during the comparison that the compared level of the honest party is $\mu_B$.
Let $b = \textsf{LCA}(\tilde\pi_\mathcal{A}, \tilde\pi_B)$ and
let $\mu_B'$ be the full level of $\pi_B$ with respect to $b$.
Then $\mu_B' \geq \mu_B$.
\end{lemma}
\begin{proof}
    Because $\mu_B$ is the compared level of the honest party we have:

    $2^{\mu_B}|\chain\{b:\}\upchain^{\mu_B}| > 2^{\mu_B}|\chain\{b:\}|$

    We will prove the claim by contradiction. Suppose $\mu_B' < \mu_B$. Because
    by definition $\mu_B'$ is the maximum level such that
    $|\overline\pi_B[\mu]\{b:\}[1:]| \geq \max(m, (1 -
    \delta)2^{-\mu}|\overline\pi_B[\mu]\{b:\}[1:]\downchain|)$, therefore
    $\mu_B$ does not satisfy this condition. But we know that
    $|\overline\pi_B[\mu_B]\{b:\}[1:]| \geq m$ because $\mu_B$ was selected by
    the Verifier. So therefore,

    \begin{equation*}
    2^{\mu_B}|\chain_B\{b:\}\upchain^{\mu_B}| < (1 - \delta)|\chain\{b:\}|
    \end{equation*}

    By the fact that $\mu_B'$ satisfies goodness, we have that:

    \begin{equation*}
    2^{\mu_B'}|\chain_B\{b:\}\upchain^{\mu_B'} > (1 - \delta)|\chain\{b:\}|
    \end{equation*}

    From the last two equations, we obtain that:

    \begin{equation*}
    (1 - \delta)|\chain\{b:\}| > 2^{\mu_B'}|\chain\{b:\}\upchain^{\mu_B'}|
    \end{equation*}

    But the last two equations contradict, hence the claim holds.
    \qed
\end{proof}

\begin{restatable}{theorem}{restateThmSecurity}
    \label{thm.security}
    The non-interactive proofs-of-proof-of-work construction for $k$-stable
    suffix-sensitive predicates is secure with overwhelming probability in
    $\kappa$.
\end{restatable}

\ifonecolumn
\import{./}{proofs/security.tex}
\else
Full proofs are included in Appendix~\ref{sec.proofs}.
\fi

\begin{remark}{(Variance attacks)}
    \label{rmk.variance}
    The critical issue addressed by this security proof is to avoid Bahack-style
    attack \cite{bahack} where the adversary constructs ``lucky'' high-difficulty
    superblocks without filling in the underlying proof-of-work in the lower
    levels. Observe that, while setting $m = 1$ ``preserves'' the proof-of-work in
    the sense that expectations remain the same, the probability of an adversarial
    attack becomes approximately proportional to the adversary power if the
    adversary follows a suitable strategy (for a description of such a strategy,
    see the parametrization section). With higher values of $m$, the probability of
    an adversarial attack drops exponentially, even though they maintain constant
    computational power, and hence satisfy a strong notion of security.
\end{remark}

% \begin{itemize}
%     \item
%         We will enforce both a lower bound and an upper bound for the length of
%         each superchain in the proof. The lower bound will be $m$. The upper
%         bound could be something like $5m$ or $m^2$? We want a limit such that
%         the probability of the proof requiring this size for an honest party is
%         negligible, therefore larger proofs can be automatically dismissed as
%         adversarial. That way we can ensure that the proofs will necessarily be
%         sublinear in size, but can also help with the security proof.
%     \item
%         When comparing an adversarial and an honest proof, they can be at the
%         same level or at different levels.
%     \item
%         If they are at the same level, then the lowest common ancestor of the
%         two chains will necessarily be close to the end of the proof, except
%         with negligible probability. This stems from the fact that in the
%         opposite case, the adversary would have to produce proof-of-work faster
%         than the honest parties and for a significant amount of time.
%     \item
%         Therefore, if the proofs are at the same level, they can be compared by
%         recursing into a lower level, one level at a time. The negligibility
%         argument for the lowest common ancestor being near the suffix applies
%         to all levels, and hence recursion should be possible.
%     \item
%         If the adversarial proof is of a higher superblock level than the
%         honest proof, then this proof will necessarily extend some honest block
%         included in the honest proof. If the honest proof is of level $\mu$ and
%         the adversarial proof is of level $\mu + 1$ this means that the
%         adversary was able to produce one or more $(\mu + 1)$-level blocks
%         which extended the $(\mu + 1)$-level blocks that exist in the
%         $\mu$-level proof of the honest parties.
%     \item
%         By the previous reasoning, the adversary should not be able to produce
%         too many of these independently of the honest party, and therefore they
%         will share a lowest common ancestor near the suffix. Proofs comparison
%         can therefore continue recursively.
%     \item
%         It seems unlikely that the adversary will be able to present a proof of
%         a higher level than the honest parties for $i >> 1$ or even $i > 1$.
%         Perhaps we can think of a formal argument for this.
%     \item
%         In case the adversarial proof is of a lower level than the honest
%         proof, it still cannot exceed the enforced upper bound of proof size.
%         Assume the upper bound were $2m$. That would necessarily entail that
%         the honest party has more proof of work than the adversarial party.
%         Does the same argument work for other upper bounds?
%     \item
%         In the above, proof-of-work amount comparison must cross different
%         superchains. i.e. the total amount of proof of work considered in each
%         case must be a weighted sum of proof-of-work for each level.
%     \item
%         This weighted sum could look as follows:
%         \begin{equation}
%             PoW =
%             \sum_{j = \mu}^{\mu + i}
%             {|\overline{\Pi}_j \setminus \overline{\Pi}_{j - 1}|}
%             + \overline{\Pi}_{\mu - 1}
%         \end{equation}
%     \item
%         When the adversary presents a lower-level superchain of level $\mu$:
%         The honest party has already presented a lower-level superchain of at
%         least $m$ blocks. The adversarial lower-level superchain can share some
%         block of these at level $\mu$ (note that the honest party has not
%         provided $\mu$-level superblocks all the way back to genesis, so a
%         common ancestor does not trivially exist). If they share a lowest
%         common ancestor within the $m$ blocks of level $\mu$ presented by the
%         honest party, then the proof comparison can continue as usual.
%     \item
%         On the other hand, if there are no shared blocks between the
%         adversarial proof and the $\mu$-level superchain of the honest proof,
%         then that means that the adversary has either produced their own
%         $\mu$-level blocks or has reused earlier $\mu$-level honest blocks.
%     \item
%         Reusing $\mu$-level honest blocks cannot be done arbitrarily. Once
%         enough blocks have been used, the proof will be upgraded to $\mu +
%         1$-level.
%     \item
%         Adversarially producing $\mu$-level blocks is possible, but $\mu +
%         1$-level blocks generated during this adversarial mining procedure must
%         be discarded after $m - 1$ blocks of superblock level $\mu + 1$ have
%         been generated.
%     \item
%         The argument then goes as follows: Assuming honest superblock proof
%         level $\mu + i$, it is hard for the adversary to produce $m$ blocks of
%         level $\mu + i - 1$, while the honest proof already has $m$ blocks of
%         that level. It becomes easier for the adversary as we approach level
%         $\mu$. But proof-of-work has to be added across multiple levels to
%         achieve a fair comparison. I'm not sure how to do that exactly.
%     \item
%         Note than in practice succinct proofs are just sets of blocks. The
%         proof level is therefore extracted by the validator by comparing
%         the blockids against $T / 2^i$.
% \end{itemize}
